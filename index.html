<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="referrer" content="no-referrer">
    <title>Family Group eke ayata Cricket</title>
    <link rel="stylesheet" href="style.css">
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
    <style>
        #debug-log {
            width: 100%;
            max-width: 600px;
            margin-top: 20px;
            padding: 10px;
            background: #222;
            color: #0f0;
            font-family: monospace;
            font-size: 0.8rem;
            border-radius: 8px;
            display: none;
            /* Hidden by default */
            word-break: break-all;
        }
    </style>
</head>

<body>
    <div class="container">
        <header>
            <h1>Family Group eke ayata Cricket</h1>
            <p>Live Stream Experience</p>
        </header>

        <main class="player-container">
            <div class="video-wrapper">
                <video id="video" controls autoplay playsinline muted></video>

                <!-- Quality Selector Overlay -->
                <div class="quality-control">
                    <label for="quality-select">Quality:</label>
                    <select id="quality-select">
                        <option value="-1">Auto</option>
                    </select>
                </div>
            </div>

            <div class="message-box">
                <p>චූටි මාමාගේ අසනීපය දුරු වේවා..!!</p>
                <p style="font-size: 0.8rem; color: #aaa; margin-top: 5px;">(If Stream doesn't play on Mobile Data,
                    please turn on a VPN)</p>
            </div>

            <div class="controls">
                <p id="status" class="status-message">Loading Stream...</p>
                <div id="debug-log"></div>
            </div>
        </main>

        <footer>
            <p>&copy; 2026 Live Stream. Premium Experience.</p>
        </footer>
    </div>

    <script>
        var video = document.getElementById('video');
        var qualitySelect = document.getElementById('quality-select');
        var statusText = document.getElementById('status');
        var videoSrc = 'https://plu001.myluck1.top:8088/live/webcricn04/playlist.m3u8?vidictid=204965757133&id=114607&pk=bdec980bd7036f2ec6113f913a209722aa7c303ec631b436540fa58acc585a3d1cfae2480de2b8d55c1c4862c845c34417bf2edd2171403f418c073361b19d42';

        if (Hls.isSupported()) {
            var config = {
                startLevel: 0,              // Force start at lowest quality
                autoLevelEnabled: false,    // DISABLE auto-switching
                maxBufferLength: 30,        // Secure buffer (30s is plenty)
                maxMaxBufferLength: 60,
                enableWorker: true,
                lowLatencyMode: false,
                manifestLoadingTimeOut: 60000, // Very long timeout for mobile
                fragLoadingTimeOut: 60000,
                // REVERT: Standard latency to ensure segments exist
                liveSyncDurationCount: 3,   // Standard safety (3 segments back)
            };
            var hls = new Hls(config);
            hls.loadSource(videoSrc);
            hls.attachMedia(video);

            hls.on(Hls.Events.MANIFEST_PARSED, function (event, data) {
                video.play();
                statusText.innerText = "Optimized for Network. Playing...";

                // Force lowest quality immediately
                hls.currentLevel = 0;
                hls.loadLevel = 0;

                // Populate quality levels
                var availableLevels = hls.levels;

                // Clear existing options
                qualitySelect.innerHTML = '';

                availableLevels.forEach(function (level, index) {
                    var option = document.createElement('option');
                    option.value = index;
                    // Use height for resolution (e.g. 360p), fallback to bitrate if height is missing
                    var resolutionText = level.height ? level.height + 'p' : Math.round(level.bitrate / 1000) + 'kbps';
                    // Add star to forced level
                    if (index === 0) resolutionText += " (Stable)";
                    option.text = resolutionText;
                    qualitySelect.appendChild(option);

                    // Select the lowest quality by default
                    if (index === 0) option.selected = true;
                });

                // Handle quality change
                qualitySelect.addEventListener('change', function () {
                    hls.currentLevel = parseInt(this.value);
                    console.log("Quality set to level index: " + this.value);
                });
                // Add Fix Network Button logic
                var fixBtn = document.createElement('button');
                fixBtn.innerText = "⚠️ Troubleshoot Network";
                fixBtn.className = "btn-fix"; // Add simple style later
                fixBtn.onclick = function () {
                    statusText.innerText = "Attempting to reset stream...";
                    hls.stopLoad();
                    hls.startLevel = -1; // Try unlocking Auto quality
                    hls.startLoad();
                    setTimeout(() => video.play(), 1000);
                };
                document.querySelector('.controls').appendChild(fixBtn);

            });

            var debugLog = document.getElementById('debug-log');
            function logError(msg) {
                debugLog.style.display = 'block';
                debugLog.innerText += "\n[ERROR] " + msg;
            }

            hls.on(Hls.Events.ERROR, function (event, data) {
                console.log("HLS Error:", data);

                if (data.type === Hls.ErrorTypes.NETWORK_ERROR) {
                    logError("Network Error: " + data.details + " (Check VPN/CORS)");
                } else if (data.fatal) {
                    logError("Fatal Error: " + data.type + " - " + data.details);
                }

                if (data.fatal) {
                    statusText.innerText = "Error: Mobile Carrier Blocked? Try VPN (" + data.details + ")";
                    // ... retry logic remains ...
                    switch (data.type) {
                        case Hls.ErrorTypes.NETWORK_ERROR:
                            console.log("fatal network error encountered, try to recover");
                            hls.startLoad();
                            break;
                        case Hls.ErrorTypes.MEDIA_ERROR:
                            console.log("fatal media error encountered, try to recover");
                            hls.recoverMediaError();
                            break;
                        default:
                            // Try to recover even on 'fatal' errors by restarting load after delay
                            setTimeout(function () {
                                hls.loadSource(videoSrc);
                                hls.startLoad();
                            }, 5000);
                            break;
                    }
                }
            });
        }
        else if (video.canPlayType('application/vnd.apple.mpegurl')) {
            // Native HLS support (Safari) doesn't support manual quality switching via JS easily
            video.src = videoSrc;
            qualitySelect.style.display = 'none'; // Hide selector on Safari
            video.addEventListener('loadedmetadata', function () {
                video.play();
                statusText.innerText = "Enjoy the Match!";
            });
            video.addEventListener('error', function (e) {
                var err = video.error;
                var debugLog = document.getElementById('debug-log');
                debugLog.style.display = 'block';
                debugLog.innerText += "\n[NATIVE ERROR] " + (err ? err.message + " (" + err.code + ")" : "Unknown");
                statusText.innerText = "Native Player Error: " + (err ? err.code : "Unknown");
            });
        }
    </script>
</body>

</html>
